## 第23章 调试

调试是确定错误根本原因并纠正此错误的过程。同测试不同，后者是检测错误的过程。在一些项目中，调试可能占到整个开发周期的50%。对很多程序员来说，调试是程序设计中最为困难的部分。

调试原本不是最难解决的问题。如果严格遵照本书所提供的建议，你几乎没有什么错误需要调试。你所面对的绝大多数问题将都是一些微笑的疏忽和拼写错误，这些很容易通过阅读源代码列表或在调试器中单步跟踪来发现。

### 23.1 调试概述

同测试一样，调试本身并不是改进代码质量的方法，而是诊断代码缺陷的一种方法。软件的质量必须从开始逐步建立：开发高质量软件产品的最佳途径是精确描述需求，完善设计，并使用高质量的代码编写规范。调试只是迫不得已时采用的手段。

效率低下的调试方法包括：凭猜测找出缺陷、不把时间浪费在理解问题上、用最唾手可得的方式修正错误。

每个团队里也许有这样一个程序员，他总会遇到无穷的问题：不听话的机器，奇怪的编译起错误，月圆时才会出现的编程语言的隐藏缺陷，失效的数据，忘记做重要的改动，一个不能正常保存程序的疯狂编辑器等等。这就是“迷信式编程”。要知道，如果你写的程序出了问题，那就是你的原因，不是计算机的，也不是编译器的。程序不会每次都产生不同的结果。它不是自己写出来的，是你写的，所以，请对它负责。

### 23.2 寻找缺陷

调试包括了寻找缺陷和修正缺陷。寻找缺陷——并且理解缺陷——通常占到了整个调试工作的90%。高效的程序员不是随机地猜测如何修正程序，他们使用科学的方法——即所有科学探索所必需的发现和实证的过程。下面给出了一种寻找缺陷的有效方法：

1. 将错误状态稳定下来；
2. 确定错误的来源
  - 收集产生缺陷的相关数据
  - 分析收集的数据，并构造对缺陷的假设
  - 确定怎样去证实或证伪这个假设，可以对程序进行测试或检查代码
  - 按照上一步对假设做出最终结论
3. 修补缺陷
4. 对修补的缺陷进行测试
5. 查找是否还有类似错误

### 23.3 修正缺陷

测试过程中最让人头疼的部分是寻找缺陷，修正缺陷则是较为简单的部分，正是因为它过于简单才让人们经常对它掉以轻心。下面给出一些如何减少出错几率的建议：

- 在动手之前先要理解问题
- 理解程序本身，而不仅仅是问题
- 验证对错误的分析
- 放松一下
- 保存最初的源代码
- 治本，而不是治标
- 修改代码时一定要有恰当的理由
- 一次只做一个改动
- 检查自己的改动
- 增加能暴露问题的单元测试
- 搜索类似的缺陷

### 23.4 调试中的心理因素

人们看到的是他们所希望看到的东西，更直白点说人总期望一个新的现象类似于他们见到过的某种现象。这种现象就是“psychological set（心理取向）”。

心理取向对调试有什么影响？首先，它证明了养成良好编程习惯的重要性。规范的格式、恰当的注释、良好的变量和子程序命名的方式，以及其他编程风格要素都有助于构建编程的良好基础。在这样的基础之上，可能发生的错误将因为与众不同而变得格外引人注目。第二个影响表现在当发现错误的时候程序员对于需要检查的程序部分的选择方面。调试高效的程序员能够在调试的时候对程序中的无关部分视而不见，然而有时包含错误的程序部分也会被程序员们错误地排除在外。

心理距离可以定义为区分两事物的难易程度。在做调试的时候，要警惕那些没有足够心理距离的相似变量名或者子程序名。而在编写代码的时候，应该为变量或子程序选择差别较大的名字，这样就可以避免此类问题的发生。

### 23.5 调试工具——明显的和不那么明显的

源代码比较工具、编译起的警告信息、增强的语法检查和逻辑检查、执行性能剖测器、测试框架/脚手架、调试器。
