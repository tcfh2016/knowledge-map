## 第26章 代码调整技术

程序性能通常同代码的速度和资源占用相关，但减小代码资源占用更主要是通过对类和数据结构的重新设计来实现，而非代码调整。代码调整更多的是指小规模的修改，而非大范围的设计变更。

本章所描述的代码调整似乎同第24章“重构”有些相似，但重构是去改善程序的内部结构。而本章所述的内容，将其称之为“反重构”而非“改善内部结构”或许更恰如其分。这种改变是以牺牲程序内部结构的某些特性来换取更高的性能。

### 26.1 逻辑

很多程序都由逻辑操作构成。本节描述了如何因势利导运用逻辑表达式。

- 在知道答案后停止判断
- 按照出现频率来调整判断顺序
- 相似逻辑结构之间的性能比较：要实现代码调整的某种“黄金法则”或是“逻辑准则”很困难，没有什么能替代测量得出的结论。
- 用查询表替代复杂表达式
- 使用惰性求值

### 26.2 循环

循环会被执行很多次，也是程序热点常见的藏身之处。本届讨论的方法能让循环本身更快。

- 将判断外提
- 合并
- 展开
- 尽可能减少在循环内部做的工作
- 哨兵值
- 把最忙的循环放在最内层
- 削减强度

### 26.3 数据变换

对某种特定数据类型实现进行恰如其分的调整，同样也能提高代码的性能。

- 使用整型数而不是浮点数
- 数组维度尽可能少
- 尽可能减少数组引用
- 使用缓存机制

### 26.4 表达式

程序里的很多工作是在数学或逻辑表达式中实现的。复杂的表达式往往代价昂贵，本章讨论减少其代价的方法。

- 利用代数恒等式
- 削弱运算强度
- 编译期初始化
- 小心系统函数
- 使用正确的常量类型
- 预先算出结果
- 删除公共子表达式

### 26.5 子程序

代码调整的利器之一就是良好的子程序分解。短小、定义明确的子程序能够代替多处单独执行相同操作的代码，因而能够节省空间。这些子程序也更容易用低级语言重写。

### 26.6 用低级语言重写代码

有一句亘古不变的箴言也不能不提：当程序遭遇性能瓶颈的时候，你应当用低级语言重写代码。

### 26.7 变得越多，事情反而越没变

比起10年前，任何特定优化的效果实际上都更加不可预测。每一步代码调整所产生的影响都受制于编程语言、编译器、编译器的版本、代码库、库版本以及编译器设置等各种因素。

代码调整无可避免地为性能改善的良好愿望而付出复杂性、可读性、简单性、可维护性方面的代价。由于每次调整后都需要对性能进行重新评估，代码调整还引入了巨额的管理维护开销。

恪守“对每次的改进进行量化”的准则是抵御思考成熟前匆忙优化之诱惑的法宝，这一准则也帮助我坚守编写清晰简单代码的一贯作风。如果某项优化非常重要，值得为它付出剖析和对优化结果量化测量的代价，那么只要优化有效还是可以去做的。但如果某项优化重要性不够，就不值得为它付出可读性、可维护性和其他代码特定恶化等方面的代价。
