## 第25章 代码调整策略

本章讨论程序性能调整问题。你可以在两个层面上考虑性能问题：策略上和技术上。本章要解决的是策略层面上的性能问题：什么是性能，它的重要性，以及提高性能的一般性方法。

### 25.1 性能概述

代码调整只是提高程序性能的一种方法。除此之外，还可以找到提高性能的其他方法，这些方法让你以更少的时间和对代码更少的负面影响来实现你的目标。

性能同代码速度之间存在着很松散的联系。如果只是关注代码的运行速度，你的工作不免顾此失彼。要特别当心放弃其他功能去让你的代码跑得更快。如果过分强调速度，程序的整体性能常常不升反降。

一旦你把效率作为头等大事，无论重点是在处理速度还是在处理代码所占用的资源上，你都应该从如下方面考虑效率问题：

- 程序需求
- 程序的设计
- 类和子程序的设计
- 程序同操作系统的交互
- 代码编译
- 硬件
- 代码调整

### 25.2 代码调整简介

代码调整对程序员到底有什么魅力？它并不是改进性能的最为有效的方法，完善程序架构，修改类的设计，选择更好的算法常常能带来更大幅度的性能提升。它同样不是最方便的改善性能的方法，购买新的硬件或使用具有更好优化特性的编译器会更方便。它也不是成本最低的方法，在初期阶段耗费在手工调整代码的实践越多，后期越难维护。

代码调整出于一下两个原因受到了程序员们的青睐。首先，这种方法似乎是在藐视自然法则，调整几行代码就能把原本花上20微妙的程序优化到2微秒，这给程序员们带来了不可思议的成就感。其次，还在于掌握编写高效代码的这门艺术是成为严肃意义上程序员所需的加冕仪式。

1）Pareto 法则

Pareto法则是总所周知的80/20法则，它讲述的是可以用20%的努力取得80%的成效。这一法则适用于程序设计之外的众多领域，对程序优化也绝对有效。

Barry Boehm的研究表明，程序中20%的子程序耗费了80%的执行时间（1987b）。在Donald Knuth的经典论文“An Empirical Study of Fortran Programs”中，作者发现程序中不足4%的部分常常占用了超过50%的运行时间（1971)。

2）一些无稽之谈

你所听到过的很多关于代码调整的观点都是错误的：

- 在高级语言中，减少代码的行数就可以提升所生成的机器代码的运行速度，或是减少其资源占用
- 特定运算可能比其他的快，代码规模也较小
- 应当随时随地进行优化
- 程序的运行速度同其正确性同等重要

3）何时调整代码

程序员应当使用高质量的设计，把程序编写正确。使之模块化并易于修改，将让后期的维护工作变得很容易。在程序已经完成并正确之后，再去检查系统的性能。

4）编译器优化

如今编译器的优化功能可能比你想象的要强大得多。如果有了优化能力很强的编译器，你的代码速度通常可以提高40%甚至翻上一倍。

### 25.3 蜜糖和哥斯拉

有些操作长期以来是笨拙不堪的，比如输入/输出操作、分页、系统调用、解释性语言和错误。另外还有一些特定的操作总是比较慢。

### 25.4 性能测量

由于程序中某些一小部分常常耗费同自己体积不成比例的运算时间，所以你应当测量代码性能，找出代码中的热点（hot spots）。一旦发现了这样的区域并对该处的代码进行了优化就再次测量，看看到底有了多少改进。*性能问题的很多方面都是违反直觉的。*

性能测量应当精确，你可以使用性能剖测工具或者系统时钟和函数来记录运算操作耗费的时间。不过需要明确：你仅仅是在测量现在正在调整代码的运行时间，应当用分配给程序的CPU时钟来计算，而不是日期时钟。与之类似，应该明确测量、程序初始化带来的额外负担，否则无论对最初代码还是调整后代码的性能测量都是不甚公平的。

### 25.5 反复调整

在确定了性能瓶颈后，尽管不可能从一种方法中获得10倍的性能改进，但你可以将多种方法有效地结合起来。
